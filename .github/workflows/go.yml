name: Release RenForge

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            arch: amd64
          - os: windows-latest
            goos: windows
            arch: amd64
          - os: macos-13
            goos: darwin
            arch: amd64
          - os: macos-latest
            goos: darwin
            arch: arm64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Install fyne tool (new)
        run: go install fyne.io/tools/cmd/fyne@latest

      # âœ… Linux build deps required by glfw/go-gl (pkg-config, OpenGL, X11 headers, etc.)
      - name: Install Linux GUI deps (Fyne)
        if: matrix.goos == 'linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libgl1-mesa-dev \
            xorg-dev \
            libx11-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxxf86vm-dev \
            libasound2-dev

      # --- macOS: create icon.icns from icon.png (no ImageMagick needed) ---
      - name: Create icon.icns from icon.png (macOS)
        if: matrix.goos == 'darwin'
        shell: bash
        run: |
          test -f icon.png

          mkdir -p icon.iconset
          sips -z 16 16     icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32     icon.png --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32     icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64     icon.png --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128   icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256   icon.png --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256   icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512   icon.png --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512   icon.png --out icon.iconset/icon_512x512.png
          sips -z 1024 1024 icon.png --out icon.iconset/icon_512x512@2x.png

          iconutil -c icns icon.iconset -o icon.icns
          test -f icon.icns
          ls -la icon.icns

      # --- Package per OS ---
      - name: Package (Windows)
        if: matrix.goos == 'windows'
        shell: bash
        run: |
          test -f icon.ico
          fyne package -os windows -name renforge -icon icon.ico

      - name: Package (Linux)
        if: matrix.goos == 'linux'
        shell: bash
        run: |
          test -f icon.png
          fyne package -os linux -name renforge -icon icon.png

      - name: Package (macOS)
        if: matrix.goos == 'darwin'
        shell: bash
        run: |
          test -f icon.icns
          fyne package -os darwin -name renforge -icon icon.icns

      # --- Create single-file artifacts per OS ---
      - name: Create artifacts (Windows)
        if: matrix.goos == 'windows'
        shell: bash
        run: |
          mkdir -p dist
          mv renforge.exe dist/renforge-windows-${{ matrix.arch }}.exe

      - name: Create artifacts (Linux)
        if: matrix.goos == 'linux'
        shell: bash
        run: |
          mkdir -p dist

          echo "Listing workspace after fyne package:"
          ls -la

          # Prefer a directory bundle if it exists, else fall back to a binary.
          if [ -d "renforge" ]; then
            echo "Found directory bundle: renforge/"
            tar -czf dist/renforge-linux-${{ matrix.arch }}.tar.gz renforge
          elif [ -f "renforge" ]; then
            echo "Found binary: renforge"
            tar -czf dist/renforge-linux-${{ matrix.arch }}.tar.gz renforge
          elif [ -f "renforge.tar.gz" ]; then
            echo "Found prebuilt tarball: renforge.tar.gz"
            mv renforge.tar.gz dist/renforge-linux-${{ matrix.arch }}.tar.gz
          else
            echo "ERROR: Could not find Linux output from fyne package."
            echo "Contents:"
            ls -la
            exit 1
          fi


      - name: Create artifacts (macOS)
        if: matrix.goos == 'darwin'
        shell: bash
        run: |
          mkdir -p dist
          ditto -c -k --sequesterRsrc --keepParent renforge.app dist/renforge-macos-${{ matrix.arch }}.zip

      - name: Upload build artifacts (for release job)
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.goos }}-${{ matrix.arch }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all dist artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten dist folder
        shell: bash
        run: |
          mkdir -p out
          find dist -type f -maxdepth 3 -exec mv {} out/ \;
          ls -la out

      - name: Create GitHub Release & upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: out/*
          generate_release_notes: true
